<template>
    <div class="min-h-screen bg-gray-50 py-4 sm:py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header with Back Button -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                <button @click="router.back()"
                    class="flex items-center text-gray-600 hover:text-gray-800 transition duration-150">
                    <ArrowLeft class="w-5 h-5 mr-2" />
                    <span class="text-sm sm:text-base">Back to Dashboard</span>
                </button>
                <div class="flex flex-col sm:flex-row gap-3 sm:space-x-4">
                    <!-- Date Range Selector -->
                    <select v-model="dateRange"
                        class="w-full sm:w-auto border rounded-md px-3 py-2 bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
            </div>

            <!-- Custom Date Range (shown when custom is selected) -->
            <div v-if="dateRange === 'custom'" class="mb-6 bg-white p-4 rounded-lg shadow">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" v-model="customDateRange.startDate"
                            class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" v-model="customDateRange.endDate"
                            class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
            </div>

            <!-- Report Types Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <!-- Sales Report -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Sales Report</h3>
                            <p class="text-sm text-gray-600 mt-1">Detailed sales transactions and revenue analytics</p>
                        </div>
                        <button @click="downloadReport('sales')" :disabled="isLoading.sales"
                            class="flex items-center px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 transition duration-150 disabled:opacity-50">
                            <span v-if="isLoading.sales" class="mr-2">
                                <RefreshCcw class="w-4 h-4 animate-spin" />
                            </span>
                            <span v-else class="mr-2">
                                <Download class="w-4 h-4" />
                            </span>
                            {{ isLoading.sales ? 'Generating...' : 'Download' }}
                        </button>
                    </div>
                </div>

                <!-- Inventory Report -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Inventory Report</h3>
                            <p class="text-sm text-gray-600 mt-1">Current stock levels and product movement</p>
                        </div>
                        <button @click="downloadReport('inventory')" :disabled="isLoading.inventory"
                            class="flex items-center px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 transition duration-150 disabled:opacity-50">
                            <span v-if="isLoading.inventory" class="mr-2">
                                <RefreshCcw class="w-4 h-4 animate-spin" />
                            </span>
                            <span v-else class="mr-2">
                                <Download class="w-4 h-4" />
                            </span>
                            {{ isLoading.inventory ? 'Generating...' : 'Download' }}
                        </button>
                    </div>
                </div>

                <!-- Customer Report -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Customer Report</h3>
                            <p class="text-sm text-gray-600 mt-1">Customer purchase history and behavior analysis</p>
                        </div>
                        <button @click="downloadReport('customers')" :disabled="isLoading.customers"
                            class="flex items-center px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 transition duration-150 disabled:opacity-50">
                            <span v-if="isLoading.customers" class="mr-2">
                                <RefreshCcw class="w-4 h-4 animate-spin" />
                            </span>
                            <span v-else class="mr-2">
                                <Download class="w-4 h-4" />
                            </span>
                            {{ isLoading.customers ? 'Generating...' : 'Download' }}
                        </button>
                    </div>
                </div>

                <!-- Financial Report -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Financial Report</h3>
                            <p class="text-sm text-gray-600 mt-1">Revenue, expenses, and profit analysis</p>
                        </div>
                        <button @click="downloadReport('financial')" :disabled="isLoading.financial"
                            class="flex items-center px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 transition duration-150 disabled:opacity-50">
                            <span v-if="isLoading.financial" class="mr-2">
                                <RefreshCcw class="w-4 h-4 animate-spin" />
                            </span>
                            <span v-else class="mr-2">
                                <Download class="w-4 h-4" />
                            </span>
                            {{ isLoading.financial ? 'Generating...' : 'Download' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Preview -->
            <div v-if="currentReport" class="mt-8">
                <div class="bg-white rounded-lg shadow">
                    <ReportViewer :reportData="currentReport" :reportType="currentReportType" />
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import { ref } from 'vue';
import { useRouter } from 'vue-router';
import { useSellerStore } from '../store/sellerStore';
import { ArrowLeft, Download, RefreshCcw } from 'lucide-vue-next';
import { toast } from 'vue-sonner';
import ReportViewer from './ReportViewer.vue';

export default {
    name: 'DownloadReports',
    components: {
        ArrowLeft,
        Download,
        RefreshCcw,
        ReportViewer
    },
    setup() {
        const router = useRouter();
        const sellerStore = useSellerStore();
        const dateRange = ref('month');
        const customDateRange = ref({
            startDate: '',
            endDate: ''
        });
        const isLoading = ref({
            sales: false,
            inventory: false,
            customers: false,
            financial: false
        });

        // Report preview state
        const currentReport = ref(null);
        const currentReportType = ref(null);

        const downloadReport = async (reportType) => {
            console.log(`[Report] Starting download for ${reportType} report`);
            isLoading.value[reportType] = true;

            try {
                const dateParams = dateRange.value === 'custom'
                    ? { startDate: customDateRange.value.startDate, endDate: customDateRange.value.endDate }
                    : { period: dateRange.value };

                const response = await sellerStore.downloadReport(reportType, dateParams);

                if (!response.data) {
                    throw new Error('No report data received');
                }

                // Update preview state
                currentReport.value = response.data;
                currentReportType.value = reportType;

                // Create download file
                const reportData = JSON.stringify(response.data, null, 2);
                const fileName = `${reportType}-report-${new Date().toISOString().split('T')[0]}.json`;
                const blob = new Blob([reportData], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                toast.success(`${reportType} report downloaded successfully`);
            } catch (error) {
                console.error(`[Report] Error:`, error);
                toast.error(error.message || `Failed to download ${reportType} report`);
                currentReport.value = null;
                currentReportType.value = null;
            } finally {
                isLoading.value[reportType] = false;
            }
        };

        return {
            router,
            dateRange,
            customDateRange,
            isLoading,
            downloadReport,
            currentReport,
            currentReportType
        };
    }
};
</script>