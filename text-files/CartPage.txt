<template>
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Shopping Cart ({{ isCartLoading ? '...' : cartStore.cartCount }})</h1>

        <div v-if="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
            role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline">{{ error }}</span>
            <button @click="retryLoading"
                class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mt-2">
                Retry
            </button>
        </div>

        <div v-else class="flex flex-col lg:flex-row gap-4 cart-container">
            <!-- Product List -->
            <div class="w-full lg:w-2/3 product-list-container">
                <div class="bg-white shadow-md rounded-lg p-4">
                    <div class="flex flex-wrap items-center mb-4">
                        <div class="flex items-center mr-4 mb-2 sm:mb-0">
                            <input type="checkbox" v-model="selectAll" @change="toggleSelectAll"
                                class="mr-2 custom-checkbox" :disabled="isCartLoading">
                            <span class="mr-4">Select all items</span>
                        </div>
                        <button @click="deleteSelectedItems" class="text-blue-500" :disabled="isCartLoading">
                            Delete selected items
                        </button>
                    </div>

                    <!-- Shipping info -->
                    <div class="bg-yellow-50 p-4 mb-4 rounded-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <div class="flex items-center space-x-2">
                                    <span class="font-semibold">Shipped by Kaalis</span>
                                    <span>
                                        <TooltipProvider>
                                            <Tooltip>
                                                <TooltipTrigger class="flex items-center">
                                                    <ShieldQuestion class="w-4 h-4" />
                                                </TooltipTrigger>
                                                <TooltipContent>
                                                    <p class="text-sm w-72">Choice items are curated, selected and
                                                        shipped directly by Kaalis. This includes a delivery guarantee
                                                        and free returns on all items.</p>
                                                </TooltipContent>
                                            </Tooltip>
                                        </TooltipProvider>
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 font-bold">
                                    To save <span class="text-red-500">US ${{ shippingCost.toFixed(2) }}</span> shipping
                                    fee shop <span class="text-red-500">US ${{ minimumForFreeShipping.toFixed(2)
                                        }}</span> more
                                </p>
                                <p class="text-sm text-gray-600">Lower carbon footprint with reduced packaging</p>
                            </div>
                            <ChevronRight class="w-5 h-5 text-gray-400 mt-2 sm:mt-0" />
                        </div>
                    </div>

                    <!-- Skeleton Loader -->
                    <div v-if="isCartLoading" class="animate-pulse">
                        <div v-for="i in 3" :key="i" class="border-b py-4 last:border-b-0">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center">
                                <div class="flex items-center mb-2 sm:mb-0">
                                    <div class="w-4 h-4 bg-gray-200 rounded mr-4"></div>
                                    <div class="w-28 h-28 bg-gray-200 rounded mr-4"></div>
                                </div>
                                <div class="flex-grow">
                                    <div class="h-6 bg-gray-200 rounded w-3/4 mb-2"></div>
                                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                                    <div class="flex justify-between items-center">
                                        <div class="h-6 bg-gray-200 rounded w-1/4"></div>
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-gray-200 rounded-full mr-2"></div>
                                            <div class="w-12 h-8 bg-gray-200 rounded mr-2"></div>
                                            <div class="w-8 h-8 bg-gray-200 rounded-full"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Items -->
                    <div v-if="cartStore.items.length === 0" class="text-center py-4">
                        <p class="text-gray-600">Your cart is empty.</p>
                    </div>
                    <div v-else v-for="item in cartStore.items" :key="item.product?._id || index"
                        class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4">
                        <div class="flex items-center mb-2 sm:mb-0">
                            <img v-if="item.product?.images?.length > 0" :src="item.product.images[0]"
                                :alt="item.product?.name || 'Product image'" class="w-16 h-16 object-cover mr-4">
                            <div v-else class="w-16 h-16 bg-gray-200 rounded mr-4 flex items-center justify-center">
                                <span class="text-gray-400">Loading...</span>
                            </div>
                            <div>
                                <h3 class="font-semibold"
                                    :title="item.product ? item.product.name : 'Product name unavailable'">
                                    {{ formatTitle(item.product ? item.product.name : 'Product name unavailable') }}
                                </h3>
                                <div class="description-container">
                                    <p class="text-gray-600 text-sm"
                                        :class="{ 'expanded': item.product?.showFullDescription }">
                                        <span v-html="formatDescription(item.product)"></span>
                                    </p>
                                    <span v-if="item.product?.description && item.product.description.length > 100"
                                        @click="toggleDescription(item.product)"
                                        class="text-blue-500 cursor-pointer text-sm">
                                        {{ item.product?.showFullDescription ? 'Read less' : 'Read more' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center mt-2 sm:mt-0">
                            <div class="flex items-center mr-4">
                                <button @click="decrementQuantity(item)" class="bg-gray-200 p-1 rounded-full"
                                    :disabled="loadingItems[item.product?._id] || !item.product?._id">
                                    <Minus class="w-4 h-4" />
                                </button>
                                <span class="mx-2">{{ item.quantity }}</span>
                                <button @click="incrementQuantity(item)" class="bg-gray-200 p-1 rounded-full"
                                    :disabled="loadingItems[item.product?._id] || !item.product?._id">
                                    <Plus class="w-4 h-4" />
                                </button>
                            </div>
                            <span class="font-semibold">US ${{ item.product && item.product?.price ?
                                (item.product?.price * item.quantity).toFixed(2) : '0.00' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="w-full lg:w-1/3 mt-4 lg:mt-0 summary-container">
                <div class="bg-white shadow-md rounded-lg p-4">
                    <h2 class="text-xl font-semibold mb-4">Summary</h2>
                    <!-- Skeleton Loader for Summary -->
                    <div v-if="isCartLoading" class="animate-pulse">
                        <div class="flex justify-between mb-2">
                            <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                        </div>
                        <div class="flex justify-between mb-4">
                            <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                        </div>
                        <div class="flex justify-between mb-4">
                            <div class="h-6 bg-gray-200 rounded w-1/4"></div>
                            <div class="h-6 bg-gray-200 rounded w-1/4"></div>
                        </div>
                        <div class="text-right mb-4">
                            <div class="h-4 bg-gray-200 rounded w-1/3 ml-auto"></div>
                        </div>
                        <div class="h-10 bg-gray-200 rounded w-full mb-4"></div>
                    </div>
                    <!-- Actual Summary Content -->
                    <div v-else>
                        <div class="flex justify-between mb-2">
                            <span>Subtotal</span>
                            <span>NGN ₦ {{ cartStore.cartTotal.toFixed(2) }}</span>
                        </div>
                        <div v-if="cartStore.items.length > 0" class="flex justify-between mb-2">
                            <span>Shipping fee</span>
                            <span>NGN ₦ {{ shippingCost.toFixed(2) }}</span>
                        </div>
                        <!-- <div class="flex justify-between mb-4">
                            <span>Promo codes</span>
                            <button @click="applyPromoCode" class="text-blue-500">Enter ▼</button>
                        </div> -->

                        <div class="flex justify-between mb-4">
                            <span>Promo codes</span>
                            <div v-if="cartStore.coupon">
                                <span>{{ cartStore.coupon.code }} applied</span>
                                <button @click="removeCoupon" class="text-red-500 ml-2">Remove</button>
                            </div>
                            <div v-else class="flex items-center justify-end">
                                <input v-model="couponCode" type="text" placeholder="Enter code"
                                    class="w-1/2 rounded-l px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button @click="applyPromoCode"
                                    class="bg-blue-500 text-white px-4 py-[0.35em] rounded-r hover:bg-blue-600 transition duration-300 border border-blue-500">
                                    Apply
                                </button>
                            </div>
                        </div>

                        <div v-if="cartStore.discount > 0" class="flex justify-between mb-4 text-green-600">
                            <span>Discount</span>
                            <span>-${{ cartStore.discount.toFixed(2) }}</span>
                        </div>

                        <div class="flex justify-between font-bold text-lg mb-4">
                            <span>Total</span>
                            <span>NGN ₦ {{ total.toFixed(2) }}</span>
                        </div>
                        <div class="text-right mb-4">
                            <span class="text-gray-600">US $ {{ (total * exchangeRate).toFixed(2) }}</span>
                        </div>
                        <button @click="proceedToCheckout"
                            class="w-full bg-[#24a6bb] text-white py-2 rounded-lg hover:bg-[#1c8a9e] transition duration-300"
                            :disabled="isCartLoading || cartStore.items.length === 0">
                            Checkout ({{ cartStore.cartCount }})
                        </button>
                    </div>

                    <!-- Payment Methods and Buyer Protection -->
                    <div class="mt-4">
                        <h3 class="font-semibold mb-2">Pay with</h3>
                        <div class="flex flex-wrap gap-2">
                            <img src="../assets/images/visa-pay.png" alt="Visa" class="h-8">
                            <img src="../assets/images/mastercard-pay.webp" alt="Mastercard" class="h-8">
                            <img src="../assets/images/google-pay.webp" alt="JCB" class="h-8">
                            <img src="../assets/images/apple-pay.webp" alt="American Express" class="h-8">
                            <img src="../assets/images/paypal-pay.webp" alt="PayPal" class="h-8">
                            <img src="../assets/images/Orange-Money-pay.jpeg" alt="Google Pay" class="h-8">
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="font-semibold mb-2">Buyer protection</h3>
                        <p class="text-sm text-gray-600 flex items-center">
                            <ShieldCheck class="w-6 h-6 mr-2 text-green-500" />
                            Get full refund if the item is not as described or if is not delivered
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- vue 3 doesn't require explicit export default -->
<script setup>
import { ref, computed, onMounted, reactive } from 'vue';
import { useRouter } from 'vue-router';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger
} from '@/components/ui/tooltip'
import { useCartStore } from '../store/cart.js';
import { ChevronRight, Trash2, Heart, ShieldCheck, Plus, Minus, ShieldQuestion } from 'lucide-vue-next';
import { toast } from 'vue-sonner';

const router = useRouter();
const cartStore = useCartStore();
const selectAll = ref(false);
const shippingCost = computed(() => {
    return cartStore.items.length > 0 ? 1.99 : 0;
});
// const total = computed(() => cartStore.cartTotal + shippingCost.value - cartStore.discount);
const total = computed(() => cartStore.totalAfterDiscount + shippingCost.value);

const minimumForFreeShipping = ref(4.99);
const exchangeRate = ref(0.00061); // NGN to USD exchange rate
const isCartLoading = ref(true);
const loadingItems = reactive({});
const error = ref(null);
const couponCode = ref('');
const discount = ref(0);

const toggleSelectAll = () => {
    cartStore.items.forEach(item => item.selected = selectAll.value);
};

const deleteSelectedItems = async () => {
    for (const item of cartStore.items) {
        if (item.selected && item.product && item.product._id) {
            await cartStore.removeFromCart(item.product._id);
        }
    }
    await refreshCart();
};

const decrementQuantity = async (item) => {
    if (loadingItems[item.product._id] || !item.product._id) return;
    loadingItems[item.product._id] = true;
    try {
        if (item.quantity > 1) {
            await cartStore.updateQuantity(item.product._id, item.quantity - 1);
        } else {
            await cartStore.removeFromCart(item.product._id);
        }
        await refreshCart();
    } catch (error) {
        console.error('Error decrementing quantity:', error);
        toast.error('Failed to update quantity');
    } finally {
        loadingItems[item.product._id] = false;
    }
};

const incrementQuantity = async (item) => {
    if (loadingItems[item.product._id] || !item.product._id) return;
    loadingItems[item.product._id] = true;
    try {
        await cartStore.updateQuantity(item.product._id, item.quantity + 1);
        await refreshCart();
    } catch (error) {
        console.error('Error incrementing quantity:', error);
        toast.error('Failed to update quantity');
    } finally {
        loadingItems[item.product._id] = false;
    }
};

const updateQuantity = async (item) => {
    await updateItemQuantity(item, item.quantity);
};

const updateItemQuantity = async (item, newQuantity) => {
    if (!item.product || !item.product._id) {
        console.error('Invalid item or product ID');
        return;
    }
    loadingItems[item.product._id] = true;
    try {
        await cartStore.updateQuantity(item.product._id, newQuantity);
        await refreshCart();
    } catch (error) {
        console.error('Error updating quantity:', error);
        toast.error('Failed to update quantity');
    } finally {
        loadingItems[item.product._id] = false;
    }
};

const removeItem = async (item) => {
    if (!item.product || !item.product._id) {
        console.error('Invalid item or product ID');
        return;
    }
    loadingItems[item.product._id] = true;
    try {
        await cartStore.removeFromCart(item.product._id);
        await refreshCart();
    } catch (error) {
        console.error('Error removing item:', error);
        toast.error('Failed to remove item from cart');
    } finally {
        loadingItems[item.product._id] = false;
    }
};

const formatTitle = (title) => {
    if (!title) return '';
    const capitalizedTitle = title.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    return capitalizedTitle.length <= 50 ? capitalizedTitle : capitalizedTitle.slice(0, 47) + '...';
};

const formatDescription = (product) => {
    if (!product || !product.description) return '';
    let description = product.description;
    // Remove any existing HTML tags
    description = description.replace(/<\/?[^>]+(>|$)/g, "");
    // Capitalize first letter of each sentence
    description = description.replace(/(^\s*\w|[.!?]\s*\w)/g, c => c.toUpperCase());
    return description;
};

const toggleDescription = (product) => {
    if (product) {
        product.showFullDescription = !product.showFullDescription;
    }
};

const refreshCart = async () => {
    isCartLoading.value = true;
    error.value = null;
    try {
        await cartStore.fetchCart();
        cartStore.calculateDiscount();

        // Log the cart items for debugging
        console.log('Cart items:', cartStore.items);

        // Check for any invalid items
        const invalidItems = cartStore.items.filter(item => !item.product || !item.product.price);
        if (invalidItems.length > 0) {
            console.error('Invalid items found:', invalidItems);
            error.value = 'Some items in your cart are no longer available.';
            toast.error('Some items in your cart are no longer available and have been removed.');

            // Remove invalid items
            await Promise.all(invalidItems.map(item => cartStore.removeFromCart(item._id)));
            await cartStore.fetchCart(); // Refresh the cart again after removing invalid items
        }
    } catch (err) {
        console.error('Error refreshing cart:', err);
        error.value = 'Failed to load cart. Please try again.';
        toast.error('Failed to refresh cart. Please try again.');
    } finally {
        isCartLoading.value = false;
    }
};

const applyPromoCode = async () => {
    if (!couponCode.value) {
        toast.error('Please enter a coupon code');
        return;
    }
    try {
        await cartStore.applyCoupon(couponCode.value);
        couponCode.value = ''; // Clear the input field
        toast.success(`Coupon applied successfully! You saved $${cartStore.discount.toFixed(2)}`);
    } catch (error) {
        console.error('Error applying coupon:', error);
        toast.error(error.response?.data?.message || 'Failed to apply coupon');
    }
};

const removeCoupon = async () => {
    try {
        await cartStore.removeCoupon();
        // Optionally refresh the cart or update UI
        await refreshCart(); // Assuming you have a refreshCart function
    } catch (error) {
        // Error is already handled in the store action
    }
};

const cartTotal = computed(() => cartStore.cartTotal);
const cartCount = computed(() => cartStore.cartCount);

const proceedToCheckout = () => {
    if (cartStore.items.length === 0) {
        toast.error('Your cart is empty. Add some items before checking out.');
        return;
    }
    // Navigate to the checkout page
    router.push({ name: 'Checkout' });
};

const retryLoading = () => {
    refreshCart();
};

onMounted(() => {
    refreshCart();
});
</script>

<style scoped>
/* Custom checkbox styling */
/* .custom-checkbox {
    appearance: none;
    -webkit-appearance: none;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #ccc;
    border-radius: 50%;
    outline: none;
    cursor: pointer;
    transition: all 0.3s ease;
} */

.custom-checkbox {
    appearance: none;
    -webkit-appearance: none;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #ccc;
    border-radius: 50%;
    outline: none;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    flex-shrink: 0;
    /* Prevent shrinking */
    margin-right: 0.5rem;
    /* Add some margin to the right */
}

.custom-checkbox:checked {
    background-color: #24a6bb;
    border-color: #24a6bb;
}

.custom-checkbox:checked::before {
    content: '\2714';
    display: block;
    text-align: center;
    color: white;
    font-size: 0.8rem;
    line-height: 1.25rem;
}

.custom-checkbox:hover {
    border-color: #24a6bb;
}

/* Add any additional styles here */
.no-spinner::-webkit-inner-spin-button,
.no-spinner::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.no-spinner {
    -moz-appearance: textfield;
}

@media (min-width: 1024px) {
    .cart-container {
        height: calc(100vh - 130px);
        /* Adjust 100px based on your header height */
        overflow: hidden;
    }

    .product-list-container {
        overflow-y: auto;
        max-height: 100%;
    }

    .summary-container {
        position: sticky;
        top: 1rem;
        /* Adjust based on your needs */
        max-height: calc(100vh - 120px);
        /* Adjust 120px based on your header height plus some padding */
        overflow-y: auto;
    }
}

/* Optional: Add this if you want to hide scrollbars on all elements */
* {
    scrollbar-width: none;
    -ms-overflow-style: none;
}

*::-webkit-scrollbar {
    display: none;
}

@media (min-width: 640px) {

    /* sm breakpoint */
    .description-container {
        max-width: calc(100% - 5rem);
        /* Adjust based on the width of your icons */
    }
}

.description-container {
    position: relative;
    width: 100%;
    max-width: 100%;
}

.description-container p {
    max-height: 3em;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.description-container p.expanded {
    max-height: none;
    overflow: visible;
}

@media (min-width: 640px) {
    .description-container {
        max-width: calc(100% - 4rem);
        /* Adjust based on the width of your icons */
    }
}
</style>


==========================================================================




<template>
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Shopping Cart ({{ cartStore.cartCount }})</h1>

        <div v-if="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
            role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline">{{ error }}</span>
            <button @click="retryLoading"
                class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mt-2">
                Retry
            </button>
        </div>

        <div v-else class="flex flex-col lg:flex-row gap-4 cart-container">
            <!-- Product List -->
            <div class="w-full lg:w-2/3 product-list-container">
                <div class="bg-white shadow-md rounded-lg p-4">
                    <div class="flex flex-wrap items-center mb-4">
                        <div class="flex items-center mr-4 mb-2 sm:mb-0">
                            <input type="checkbox" v-model="selectAll" @change="toggleSelectAll"
                                class="mr-2 custom-checkbox">
                            <span class="mr-4">Select all items</span>
                        </div>
                        <button @click="deleteSelectedItems" class="text-blue-500">
                            Delete selected items
                        </button>
                    </div>

                    <!-- Shipping info -->
                    <div class="bg-yellow-50 p-4 mb-4 rounded-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <div class="flex items-center space-x-2">
                                    <span class="font-semibold">Shipped by Kaalis</span>
                                    <span>
                                        <TooltipProvider>
                                            <Tooltip>
                                                <TooltipTrigger class="flex items-center">
                                                    <ShieldQuestion class="w-4 h-4" />
                                                </TooltipTrigger>
                                                <TooltipContent>
                                                    <p class="text-sm w-72">Choice items are curated, selected and
                                                        shipped directly by Kaalis. This includes a delivery guarantee
                                                        and free returns on all items.</p>
                                                </TooltipContent>
                                            </Tooltip>
                                        </TooltipProvider>
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 font-bold">
                                    To save <span class="text-red-500">US ${{ shippingCost.toFixed(2) }}</span> shipping
                                    fee shop <span class="text-red-500">US ${{ minimumForFreeShipping.toFixed(2)
                                        }}</span> more
                                </p>
                                <p class="text-sm text-gray-600">Lower carbon footprint with reduced packaging</p>
                            </div>
                            <ChevronRight class="w-5 h-5 text-gray-400 mt-2 sm:mt-0" />
                        </div>
                    </div>

                    <!-- Product Items -->
                    <div v-if="cartStore.items.length === 0" class="text-center py-4">
                        <p class="text-gray-600">Your cart is empty.</p>
                    </div>
                    <div v-else v-for="item in cartStore.items" :key="item.product?._id"
                        class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4">
                        <div class="flex items-center mb-2 sm:mb-0">
                            <img v-if="item.product?.images?.length > 0" :src="item.product.images[0]"
                                :alt="item.product?.name || 'Product image'" class="w-16 h-16 object-cover mr-4">
                            <div v-else class="w-16 h-16 bg-gray-200 rounded mr-4 flex items-center justify-center">
                                <span class="text-gray-400">No image</span>
                            </div>
                            <div>
                                <h3 class="font-semibold" :title="item.product?.name || 'Product name unavailable'">
                                    {{ formatTitle(item.product?.name || 'Product name unavailable') }}
                                </h3>
                                <div class="description-container">
                                    <p class="text-gray-600 text-sm" :class="{ 'expanded': item.showFullDescription }">
                                        <span v-html="formatDescription(item.product)"></span>
                                    </p>
                                    <span v-if="item.product?.description && item.product.description.length > 100"
                                        @click="toggleDescription(item)" class="text-blue-500 cursor-pointer text-sm">
                                        {{ item.showFullDescription ? 'Read less' : 'Read more' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center mt-2 sm:mt-0">
                            <div class="flex items-center mr-4">
                                <button @click="decrementQuantity(item)" class="bg-gray-200 p-1 rounded-full"
                                    :disabled="loadingItems[item.product?._id]">
                                    <Minus class="w-3 h-3" />
                                </button>
                                <span class="mx-2">{{ item.quantity }}</span>
                                <button @click="incrementQuantity(item)" class="bg-gray-200 p-1 rounded-full"
                                    :disabled="loadingItems[item.product?._id]">
                                    <Plus class="w-3 h-3" />
                                </button>
                            </div>
                            <span class="font-semibold">
                                US ${{ item.product?.price ? (item.product.price * item.quantity).toFixed(2) : '0.00' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="w-full lg:w-1/3 mt-4 lg:mt-0 summary-container">
                <div class="bg-white shadow-md rounded-lg p-4">
                    <h2 class="text-xl font-semibold mb-4">Summary</h2>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span>Subtotal</span>
                            <span>NGN ₦ {{ cartStore.cartTotal.toFixed(2) }}</span>
                        </div>
                        <div v-if="cartStore.items.length > 0" class="flex justify-between mb-2">
                            <span>Shipping fee</span>
                            <span>NGN ₦ {{ shippingCost.toFixed(2) }}</span>
                        </div>
                        <div class="flex justify-between mb-4">
                            <span>Promo codes</span>
                            <div v-if="cartStore.coupon">
                                <span>{{ cartStore.coupon.code }} applied</span>
                                <button @click="removeCoupon" class="text-red-500 ml-2">Remove</button>
                            </div>
                            <div v-else class="flex items-center justify-end">
                                <input v-model="couponCode" type="text" placeholder="Enter code"
                                    class="w-1/2 rounded-l px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button @click="applyPromoCode"
                                    class="bg-blue-500 text-white px-4 py-[0.35em] rounded-r hover:bg-blue-600 transition duration-300 border border-blue-500">
                                    Apply
                                </button>
                            </div>
                        </div>
                        <div v-if="cartStore.discount > 0" class="flex justify-between mb-4 text-green-600">
                            <span>Discount</span>
                            <span>-${{ cartStore.discount.toFixed(2) }}</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg mb-4">
                            <span>Total</span>
                            <span>NGN ₦ {{ total.toFixed(2) }}</span>
                        </div>
                        <div class="text-right mb-4">
                            <span class="text-gray-600">US $ {{ (total * exchangeRate).toFixed(2) }}</span>
                        </div>
                        <button @click="proceedToCheckout"
                            class="w-full bg-[#24a6bb] text-white py-2 rounded-lg hover:bg-[#1c8a9e] transition duration-300"
                            :disabled="cartStore.items.length === 0">
                            Checkout ({{ cartStore.cartCount }})
                        </button>
                    </div>

                    <!-- Payment Methods and Buyer Protection -->
                    <div class="mt-4">
                        <h3 class="font-semibold mb-2">Pay with</h3>
                        <div class="flex flex-wrap gap-2">
                            <img src="../assets/images/visa-pay.png" alt="Visa" class="h-8">
                            <img src="../assets/images/mastercard-pay.webp" alt="Mastercard" class="h-8">
                            <img src="../assets/images/google-pay.webp" alt="JCB" class="h-8">
                            <img src="../assets/images/apple-pay.webp" alt="American Express" class="h-8">
                            <img src="../assets/images/paypal-pay.webp" alt="PayPal" class="h-8">
                            <img src="../assets/images/Orange-Money-pay.jpeg" alt="Google Pay" class="h-8">
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="font-semibold mb-2">Buyer protection</h3>
                        <p class="text-sm text-gray-600 flex items-center">
                            <ShieldCheck class="w-6 h-6 mr-2 text-green-500" />
                            Get full refund if the item is not as described or if is not delivered
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- vue 3 doesn't require explicit export default -->
<script setup>
import { ref, computed, onMounted, reactive } from 'vue';
import { useRouter } from 'vue-router';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger
} from '@/components/ui/tooltip'
import { useCartStore } from '../store/cart.js';
import { ChevronRight, Trash2, Heart, ShieldCheck, Plus, Minus, ShieldQuestion } from 'lucide-vue-next';
import { toast } from 'vue-sonner';

const router = useRouter();
const cartStore = useCartStore();
const selectAll = ref(false);
const shippingCost = computed(() => cartStore.items.length > 0 ? 1.99 : 0);
const total = computed(() => cartStore.totalAfterDiscount + shippingCost.value);

const minimumForFreeShipping = ref(4.99);
const exchangeRate = ref(0.00061); // NGN to USD exchange rate
const loadingItems = reactive({});
const error = ref(null);
const couponCode = ref('');

const toggleSelectAll = () => {
    cartStore.items.forEach(item => item.selected = selectAll.value);
};

const deleteSelectedItems = async () => {
    for (const item of cartStore.items) {
        if (item.selected && item.product && item.product._id) {
            await cartStore.removeFromCart(item.product._id);
        }
    }
    await refreshCart();
};

const decrementQuantity = async (item) => {
    if (loadingItems[item.product._id]) return;
    loadingItems[item.product._id] = true;
    try {
        if (item.quantity > 1) {
            await cartStore.updateQuantity(item.product._id, item.quantity - 1);
        } else {
            await cartStore.removeFromCart(item.product._id);
        }
        await refreshCart();
    } catch (error) {
        console.error('Error decrementing quantity:', error);
        toast.error('Failed to update quantity');
    } finally {
        loadingItems[item.product._id] = false;
    }
};

const incrementQuantity = async (item) => {
    if (loadingItems[item.product._id]) return;
    loadingItems[item.product._id] = true;
    try {
        await cartStore.updateQuantity(item.product._id, item.quantity + 1);
        await refreshCart();
    } catch (error) {
        console.error('Error incrementing quantity:', error);
        toast.error('Failed to update quantity');
    } finally {
        loadingItems[item.product._id] = false;
    }
};

const formatTitle = (title) => {
    if (!title) return '';
    const capitalizedTitle = title.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    return capitalizedTitle.length <= 50 ? capitalizedTitle : capitalizedTitle.slice(0, 47) + '...';
};

const formatDescription = (product) => {
    if (!product || !product.description) return '';
    let description = product.description;
    description = description.replace(/<\/?[^>]+(>|$)/g, "");
    return description.replace(/(^\s*\w|[.!?]\s*\w)/g, c => c.toUpperCase());
};

const toggleDescription = (item) => {
    if (item) {
        item.showFullDescription = !item.showFullDescription;
    }
};

const refreshCart = async () => {
    error.value = null;
    try {
        await cartStore.fetchCart();
        cartStore.calculateDiscount();
        console.log('Cart items:', cartStore.items);

        const invalidItems = cartStore.items.filter(item => !item.product || !item.product.price);
        if (invalidItems.length > 0) {
            console.error('Invalid items found:', invalidItems);
            error.value = 'Some items in your cart are no longer available.';
            toast.error('Some items in your cart are no longer available and have been removed.');

            await Promise.all(invalidItems.map(item => cartStore.removeFromCart(item._id)));
            await cartStore.fetchCart();
        }
    } catch (err) {
        console.error('Error refreshing cart:', err);
        error.value = 'Failed to load cart. Please try again.';
        toast.error('Failed to refresh cart. Please try again.');
    }
};

const applyPromoCode = async () => {
    if (!couponCode.value) {
        toast.error('Please enter a coupon code');
        return;
    }
    try {
        await cartStore.applyCoupon(couponCode.value);
        couponCode.value = ''; // Clear the input field
        toast.success(`Coupon applied successfully! You saved $${cartStore.discount.toFixed(2)}`);
    } catch (error) {
        console.error('Error applying coupon:', error);
        toast.error(error.response?.data?.message || 'Failed to apply coupon');
    }
};

const removeCoupon = async () => {
    try {
        await cartStore.removeCoupon();
        await refreshCart();
    } catch (error) {
        console.error('Error removing coupon:', error);
        toast.error('Failed to remove coupon');
    }
};

const proceedToCheckout = () => {
    if (cartStore.items.length === 0) {
        toast.error('Your cart is empty. Add some items before checking out.');
        return;
    }
    router.push({ name: 'Checkout' });
};

const retryLoading = () => {
    refreshCart();
};

onMounted(() => {
    refreshCart();
});
</script>

<style scoped>
/* Custom checkbox styling */
/* .custom-checkbox {
    appearance: none;
    -webkit-appearance: none;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #ccc;
    border-radius: 50%;
    outline: none;
    cursor: pointer;
    transition: all 0.3s ease;
} */

.custom-checkbox {
    appearance: none;
    -webkit-appearance: none;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #ccc;
    border-radius: 50%;
    outline: none;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    flex-shrink: 0;
    /* Prevent shrinking */
    margin-right: 0.5rem;
    /* Add some margin to the right */
}

.custom-checkbox:checked {
    background-color: #24a6bb;
    border-color: #24a6bb;
}

.custom-checkbox:checked::before {
    content: '\2714';
    display: block;
    text-align: center;
    color: white;
    font-size: 0.8rem;
    line-height: 1.25rem;
}

.custom-checkbox:hover {
    border-color: #24a6bb;
}

/* Add any additional styles here */
.no-spinner::-webkit-inner-spin-button,
.no-spinner::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.no-spinner {
    -moz-appearance: textfield;
}

@media (min-width: 1024px) {
    .cart-container {
        height: calc(100vh - 130px);
        /* Adjust 100px based on your header height */
        overflow: hidden;
    }

    .product-list-container {
        overflow-y: auto;
        max-height: 100%;
    }

    .summary-container {
        position: sticky;
        top: 1rem;
        /* Adjust based on your needs */
        max-height: calc(100vh - 120px);
        /* Adjust 120px based on your header height plus some padding */
        overflow-y: auto;
    }
}

/* Optional: Add this if you want to hide scrollbars on all elements */
* {
    scrollbar-width: none;
    -ms-overflow-style: none;
}

*::-webkit-scrollbar {
    display: none;
}

@media (min-width: 640px) {

    /* sm breakpoint */
    .description-container {
        max-width: calc(100% - 5rem);
        /* Adjust based on the width of your icons */
    }
}

.description-container {
    position: relative;
    width: 100%;
    max-width: 100%;
}

.description-container p {
    max-height: 3em;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.description-container p.expanded {
    max-height: none;
    overflow: visible;
}

@media (min-width: 640px) {
    .description-container {
        max-width: calc(100% - 4rem);
        /* Adjust based on the width of your icons */
    }
}
</style>
