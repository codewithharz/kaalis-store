<template>
    <div class="w-full max-w-7xl mx-auto pb-9 bg-white px-4 sm:px-6 lg:px-8">
        <Breadcrumb :breadcrumbs="breadcrumbs" />
        <div v-if="loading" class="text-center py-8">
            <div class="spinner"></div>
            <p class="mt-4">Loading products...</p>
        </div>
        <div v-else-if="error" class="text-center text-red-500 py-8">
            {{ error }}
        </div>
        <div v-else class="flex flex-col lg:flex-row">
            <!-- Mobile Filter Toggle Button -->
            <button @click="toggleFilters" class="lg:hidden mb-4 bg-gray-200 px-4 py-2 rounded-md text-sm font-medium">
                {{ showFilters ? 'Hide Filters' : 'Show Filters' }}
            </button>

            <!-- Sidebar Filter -->
            <div :class="['lg:w-1/4 pr-4', { 'hidden': !showFilters, 'block': showFilters, 'lg:block': true }]">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="font-bold">Filters</h2>
                    <button @click="clearFilters"
                        class="text-blue-500 hover:text-blue-700 text-xs transition duration-300">Clear All</button>
                </div>

                <!-- Price Filter -->
                <div class="mb-4">
                    <h3 class="font-semibold mb-2">Price</h3>
                    <div v-for="(range, index) in priceCounts" :key="index" class="flex items-center text-sm mb-1">
                        <input type="checkbox" :id="'price-' + index" v-model="selectedPriceRanges" :value="range.value"
                            class="mr-2">
                        <label :for="'price-' + index">{{ range.label }} ({{ range.count }})</label>
                    </div>
                </div>

                <!-- Discount Filter -->
                <div class="mb-4">
                    <h3 class="font-semibold mb-2">Discount</h3>
                    <div v-for="(range, index) in discountCounts" :key="index" class="flex items-center text-sm mb-1">
                        <input type="checkbox" :id="'discount-' + index" v-model="selectedDiscountRanges"
                            :value="range.value" class="mr-2">
                        <label :for="'discount-' + index">{{ range.label }} ({{ range.count }})</label>
                    </div>
                </div>
            </div>

            <!-- Product Listing -->
            <div class="lg:w-3/4">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h1 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-0">{{ categoryName }}</h1>
                    <p class="text-sm text-gray-600">{{ filteredProducts.length }} products found</p>
                </div>

                <!-- Search and Sort -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0">
                    <div class="w-full sm:w-auto relative">
                        <input v-model="searchQuery" type="text" placeholder="Search products..."
                            class="w-full sm:w-72 text-sm border border-gray-300 rounded-md py-2 px-3 pr-10 bg-gray-200 placeholder:text-xs placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#ff934b] focus:border-transparent">
                        <Search class="absolute w-5 h-5 right-3 top-1/2 transform -translate-y-1/2 text-[#ff934b]" />
                    </div>

                    <div class="w-full sm:w-auto">
                        <select v-model="sortOption" class="w-full sm:w-auto border p-2 rounded text-sm">
                            <option value="">Sort By</option>
                            <option value="price-low-high">Price Low to High</option>
                            <option value="price-high-low">Price High to Low</option>
                            <option value="name-a-z">Name (A to Z)</option>
                            <option value="name-z-a">Name (Z to A)</option>
                            <option value="discount">Discount</option>
                        </select>
                    </div>
                </div>

                <!-- Product Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <div v-for="product in filteredProducts" :key="product._id"
                        class="bg-white rounded-lg overflow-hidden transition duration-300 transform border hover:shadow-md flex flex-col">
                        <CustomImage :src="product.images[0]" :alt="product.name" :showButton="true"
                            @click="viewProduct(product._id)" />
                        <div class="p-4 flex-grow flex flex-col justify-between">
                            <div>
                                <h3 @click="viewProduct(product._id)"
                                    class="font-medium cursor-pointer text-sm sm:text-base">{{ product.name }}</h3>
                                <p class="text-[#363636] text-xs sm:text-sm mt-1">{{ product.description }}</p>
                            </div>
                            <div class="mt-2">
                                <p class="text-[#f47a24] font-semibold text-sm sm:text-base">₦ {{
                                    product.price.toFixed(2) }}</p>
                                <p v-if="product.discount" class="text-[#f47a24] text-xs sm:text-sm">{{ product.discount
                                    }}% off</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import { ref, computed, onMounted, watch } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useProductStore } from '../store/productStore.js';
import { Search } from 'lucide-vue-next';
import CustomImage from './CustomImage.vue';
import Breadcrumb from './Breadcrumb.vue';

export default {
    name: 'CategoryProducts',
    components: { Search, CustomImage, Breadcrumb },
    setup() {
        const route = useRoute();
        const router = useRouter();
        const productStore = useProductStore();

        const loading = ref(true);
        const error = ref(null);
        const products = ref([]);
        const categoryName = ref('');
        const searchQuery = ref('');
        const sortOption = ref('');
        const selectedPriceRanges = ref([]);
        const selectedDiscountRanges = ref([]);
        const showFilters = ref(false);

        const category = ref(null);
        const breadcrumbs = ref([]);

        const fetchProducts = async () => {
            try {
                loading.value = true;
                const categorySlug = route.params.categorySlug;
                const result = await productStore.fetchProductsByCategory(categorySlug);
                products.value = result.products;
                categoryName.value = result.categoryName;
                category.value = { name: result.categoryName, slug: categorySlug };

                // Update breadcrumbs
                breadcrumbs.value = [
                    { name: 'Home', path: '/' },
                    ...result.categoryPath.map(cat => ({
                        name: cat.name,
                        path: `/category/${cat.slug}`
                    }))
                ];
            } catch (err) {
                error.value = 'Failed to load products. Please try again.';
            } finally {
                loading.value = false;
            }
        };

        //onMounted(fetchProducts);
        onMounted(() => {
            fetchProducts().catch(err => {
                console.error('Error in onMounted:', err);
                error.value = 'An unexpected error occurred. Please try again.';
            });
        });

        // Watch for changes in the routehttps://claude.ai/images/home-page-assets/mermaid.svg
        // watch(() => route.params.categorySlug, (newSlug, oldSlug) => {
        //     if (newSlug !== oldSlug) {
        //         fetchProducts();
        //     }
        // });
        watch(() => route.params.categorySlug, (newSlug, oldSlug) => {
            if (newSlug !== oldSlug) {
                fetchProducts().catch(err => {
                    console.error('Error in route watcher:', err);
                    error.value = 'An error occurred while updating products. Please refresh the page.';
                });
            }
        });

        const filteredProducts = computed(() => {
            let result = products.value;

            if (searchQuery.value) {
                result = result.filter(product =>
                    product.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                    product.description.toLowerCase().includes(searchQuery.value.toLowerCase())
                );
            }

            if (selectedPriceRanges.value.length) {
                result = result.filter(product => {
                    return selectedPriceRanges.value.some(range => {
                        const [min, max] = range.split('-').map(Number);
                        return product.price >= min && (max === 0 || product.price <= max);
                    });
                });
            }

            if (selectedDiscountRanges.value.length) {
                result = result.filter(product => {
                    return selectedDiscountRanges.value.some(range => {
                        const minDiscount = parseInt(range);
                        return product.discount >= minDiscount;
                    });
                });
            }

            switch (sortOption.value) {
                case 'price-low-high':
                    result.sort((a, b) => a.price - b.price);
                    break;
                case 'price-high-low':
                    result.sort((a, b) => b.price - a.price);
                    break;
                case 'name-a-z':
                    result.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-z-a':
                    result.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'discount':
                    result.sort((a, b) => (b.discount || 0) - (a.discount || 0));
                    break;
            }

            return result;
        });

        const priceCounts = computed(() => {
            const ranges = [
                { label: '₦0 - ₦1,000', value: '0-1000' },
                { label: '₦1,000 - ₦5,000', value: '1000-5000' },
                { label: '₦5,000 - ₦10,000', value: '5000-10000' },
                { label: '₦10,000 - ₦50,000', value: '10000-50000' },
                { label: 'Above ₦50,000', value: '50000-0' }
            ];

            return ranges.map(range => {
                const [min, max] = range.value.split('-').map(Number);
                const count = products.value.filter(product =>
                    product.price >= min && (max === 0 || product.price <= max)
                ).length;
                return { ...range, count };
            });
        });

        const discountCounts = computed(() => {
            const ranges = [
                { label: '10% and above', value: '10' },
                { label: '20% and above', value: '20' },
                { label: '30% and above', value: '30' },
                { label: '40% and above', value: '40' },
                { label: '50% and above', value: '50' }
            ];

            return ranges.map(range => {
                const count = products.value.filter(product =>
                    product.discount >= parseInt(range.value)
                ).length;
                return { ...range, count };
            });
        });

        const clearFilters = () => {
            selectedPriceRanges.value = [];
            selectedDiscountRanges.value = [];
            searchQuery.value = '';
            sortOption.value = '';
        };

        const viewProduct = (productId) => {
            router.push({ name: 'ProductDetails', params: { id: productId } });
        };

        const toggleFilters = () => {
            showFilters.value = !showFilters.value;
        };

        return {
            loading,
            error,
            categoryName,
            products,
            filteredProducts,
            searchQuery,
            sortOption,
            selectedPriceRanges,
            selectedDiscountRanges,
            priceCounts,
            discountCounts,
            clearFilters,
            viewProduct,
            breadcrumbs,
            showFilters,
            toggleFilters
        };
    }
};
</script>

<style scoped>
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }
}
</style>