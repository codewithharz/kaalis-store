<!-- frontend/src/views/SellerAnalytics.vue -->
<template>
    <div class="min-h-screen bg-gray-50 py-4 sm:py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header with Back Button - Mobile Friendly -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                <button @click="router.back()"
                    class="flex items-center text-gray-600 hover:text-gray-800 transition duration-150">
                    <ArrowLeft class="w-5 h-5 mr-2" />
                    <span class="text-sm sm:text-base">Back to Dashboard</span>
                </button>
                <div class="flex flex-col sm:flex-row gap-3 sm:space-x-4">
                    <!-- Date Range Selector - Full Width on Mobile -->
                    <select v-model="dateRange"
                        class="w-full sm:w-auto border rounded-md px-3 py-2 bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                    </select>
                    <button @click="refreshData"
                        class="flex items-center justify-center px-4 py-2 bg-white border rounded-md text-gray-600 hover:bg-gray-50">
                        <RefreshCcw class="w-4 h-4 mr-2" />
                        <span class="text-sm sm:text-base">Refresh</span>
                    </button>
                </div>
            </div>

            <!-- Analytics Content -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow">
                <h2 class="text-xl sm:text-2xl font-bold mb-6">Analytics Dashboard</h2>

                <!-- Key Metrics Cards - Scrollable on Mobile -->
                <div class="overflow-x-auto pb-2 -mx-4 px-4 sm:overflow-x-visible sm:pb-0 sm:px-0">
                    <div class="flex sm:grid sm:grid-cols-2 lg:grid-cols-4 gap-4 min-w-max sm:min-w-0">
                        <div v-for="metric in keyMetrics" :key="metric.title"
                            class="w-72 sm:w-auto p-4 rounded-lg border bg-gradient-to-br from-white to-gray-50">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-600 text-sm sm:text-base">{{ metric.title }}</span>
                                <component :is="metric.icon" class="w-5 h-5 text-purple-500" />
                            </div>
                            <div class="flex items-baseline">
                                <span class="text-xl sm:text-2xl font-bold">{{ metric.value }}</span>
                                <span :class="[
                                    'ml-2 text-xs sm:text-sm',
                                    metric.trend > 0 ? 'text-green-500' : 'text-red-500'
                                ]">
                                    {{ metric.trend > 0 ? '↑' : '↓' }} {{ Math.abs(metric.trend) }}%
                                </span>
                            </div>
                            <p class="text-xs sm:text-sm text-gray-500 mt-1">vs last period</p>
                        </div>
                    </div>
                </div>

                <!-- Sales Chart - Adjusted Height for Mobile -->
                <div class="mb-6 sm:mb-8 p-4 border rounded-lg mt-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                        <h3 class="text-lg sm:text-xl font-semibold">Sales Overview</h3>
                        <div class="flex space-x-2">
                            <button v-for="view in ['Daily', 'Weekly', 'Monthly']" :key="view"
                                @click="changeTimeView(view.toLowerCase())" :class="[
                                    'px-3 py-1 rounded-md text-xs sm:text-sm',
                                    timeView === view.toLowerCase()
                                        ? 'bg-purple-100 text-purple-700'
                                        : 'text-gray-600 hover:bg-gray-100'
                                ]">
                                {{ view }}
                            </button>
                        </div>
                    </div>
                    <div class="h-60 sm:h-80">
                        <LineChart :data="salesData" :options="chartOptions" />
                    </div>
                </div>

                <!-- Two Column Layout - Stack on Mobile -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Top Products -->
                    <div class="border rounded-lg p-4">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                            <h3 class="text-lg sm:text-xl font-semibold">Top Products</h3>
                            <select v-model="productSort" class="w-full sm:w-auto text-sm border rounded px-2 py-1">
                                <option value="sales">By Sales</option>
                                <option value="revenue">By Revenue</option>
                                <option value="growth">By Growth</option>
                            </select>
                        </div>
                        <div class="space-y-4">
                            <div v-for="product in sortedProducts" :key="product.name"
                                class="flex flex-col sm:flex-row sm:items-center justify-between p-2 hover:bg-gray-50 rounded gap-2">
                                <div class="flex items-center space-x-3">
                                    <div class="w-2 h-2 rounded-full" :style="{ backgroundColor: product.color }"></div>
                                    <span class="text-sm sm:text-base">{{ product.name }}</span>
                                </div>
                                <div class="flex items-center justify-between sm:justify-end w-full sm:w-auto gap-4">
                                    <span class="text-gray-600 text-sm">{{ product.sales }}</span>
                                    <span class="text-xs sm:text-sm"
                                        :class="product.growth >= 0 ? 'text-green-500' : 'text-red-500'">
                                        {{ product.growth }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Status -->
                    <div class="border rounded-lg p-4">
                        <h3 class="text-lg sm:text-xl font-semibold mb-4">Orders by Status</h3>
                        <div class="h-48 sm:h-64">
                            <DoughnutChart :data="orderStatusData" :options="doughnutOptions" />
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div v-for="status in orderStatusData.labels" :key="status"
                                class="flex items-center space-x-2">
                                <div class="w-3 h-3 rounded-full" :style="{ backgroundColor: getStatusColor(status) }">
                                </div>
                                <span class="text-xs sm:text-sm text-gray-600">{{ status }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div v-if="isLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-4 rounded-lg flex items-center space-x-3">
                <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <span class="text-gray-700">Loading...</span>
            </div>
        </div>
    </div>
</template>

<script>
import { ref, onMounted, computed } from 'vue';
import { useRouter } from 'vue-router';
import { Line as LineChart, Doughnut as DoughnutChart } from 'vue-chartjs';
import { ArrowLeft, RefreshCcw } from 'lucide-vue-next';
import { useSellerStore } from '../store/sellerStore';
import { toast } from 'vue-sonner';

export default {
    components: {
        LineChart,
        DoughnutChart,
        ArrowLeft,
        RefreshCcw
    },

    setup() {
        const router = useRouter();
        const sellerStore = useSellerStore();
        const dateRange = ref('30');
        const timeView = ref('daily');
        const productSort = ref('sales');
        const isLoading = ref(false);

        const keyMetrics = ref([
            {
                title: 'Total Revenue',
                value: '₦2.4M',
                trend: 12.5,
                icon: 'TrendingUpIcon'
            },
            {
                title: 'Total Orders',
                value: '156',
                trend: 8.2,
                icon: 'ShoppingBagIcon'
            },
            {
                title: 'Active Customers',
                value: '86',
                trend: -2.4,
                icon: 'UsersIcon'
            },
            {
                title: 'Average Order Value',
                value: '₦15.2K',
                trend: 6.8,
                icon: 'CreditCardIcon'
            }
        ]);

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        };

        const doughnutOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            cutout: '70%'
        };

        const salesData = ref({
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Sales',
                data: [30, 45, 38, 52, 48, 60],
                fill: true,
                borderColor: '#7C3AED',
                backgroundColor: 'rgba(124, 58, 237, 0.1)',
                tension: 0.4
            }]
        });

        const topProducts = ref([
            { name: 'Whole Grain Pasta', sales: 245, revenue: 980000, growth: 12, color: '#7C3AED' },
            { name: 'MacBook Pro M3', sales: 189, revenue: 567000000, growth: 8, color: '#10B981' },
            { name: 'iPhone 15 Pro', sales: 156, revenue: 187200000, growth: -2, color: '#F59E0B' },
            { name: 'AirPods Pro', sales: 124, revenue: 49600000, growth: 5, color: '#6366F1' }
        ]);

        const orderStatusData = ref({
            labels: ['Pending', 'Processing', 'Shipped', 'Delivered'],
            datasets: [{
                data: [15, 25, 20, 40],
                backgroundColor: [
                    '#F59E0B',
                    '#7C3AED',
                    '#10B981',
                    '#6366F1'
                ]
            }]
        });

        const sortedProducts = computed(() => {
            return [...topProducts.value].sort((a, b) => {
                if (productSort.value === 'sales') return b.sales - a.sales;
                if (productSort.value === 'revenue') return b.revenue - a.revenue;
                return b.growth - a.growth;
            });
        });

        const getStatusColor = (status) => {
            const colors = {
                'Pending': '#F59E0B',
                'Processing': '#7C3AED',
                'Shipped': '#10B981',
                'Delivered': '#6366F1'
            };
            return colors[status];
        };

        const fetchAnalytics = async () => {
            isLoading.value = true;
            try {
                const data = await sellerStore.fetchAnalytics({
                    dateRange: dateRange.value,
                    timeView: timeView.value
                });
                // Update your reactive refs with the fetched data
                toast.success('Analytics data updated');
            } catch (error) {
                toast.error('Failed to fetch analytics data');
            } finally {
                isLoading.value = false;
            }
        };

        const changeTimeView = (view) => {
            timeView.value = view;
            fetchAnalytics();
        };

        const refreshData = () => {
            fetchAnalytics();
        };

        onMounted(() => {
            fetchAnalytics();
        });

        return {
            router,
            dateRange,
            timeView,
            productSort,
            isLoading,
            keyMetrics,
            salesData,
            chartOptions,
            doughnutOptions,
            sortedProducts,
            orderStatusData,
            getStatusColor,
            changeTimeView,
            refreshData
        };
    }
};
</script>